
<polymer-element name="chat-page" attributes="user">
    <template>
        <link rel="stylesheet" href="chat-page.css">
        <div layout vertical fit>
            <core-header-panel id="chatPage" lex>  <!--  mode="seamed"  to hide shadow-->
                <core-toolbar class="toolbar animate">
                    <paper-icon-button icon="arrow-back" on-click="{{goBack}}">
                    </paper-icon-button>
                    <!--<div id="title" flex>Chat with {{user.name}}</div>-->
                    <div id="roomName" flex>Let's chat</div>
                    <!--top right menu-->
                    <div hero-id="name{{user.id}}" hero>{{user.name}}</div>
                    <img class="user-avatar" width="70" height="70" src="{{user.avatar}}" hero-id="avatar{{user.id}}" hero>
                </core-toolbar>

                <div id="listChat" fit hero-id="user{{user.id}}" hero >
                    <paper-spinner active?={{activeSpinner}}></paper-spinner>
                    <!--                    <core-list class="core-list-chat" data="{{messages}}"  
                                                   runwayFactor="5">-->
                    <template repeat="{{model in messages}}">
                        <div class="chat"><span style="font-weight: bold">{{model.name}}</span>: <span>{{model.text}}</span></div> 
                    </template>
                    <!--</core-list>-->
                </div>
            </core-header-panel>
            <div horizontal layout >
                <div horizontal layout center>
                    <paper-icon-button id="btnSpeak" icon="keyboard-voice" on-click="{{turnOnSpeak}}" >
                    </paper-icon-button>
                </div>
                <paper-input-decorator label="Type then enter" floatingLabel flex>
                    <input is="core-input" on-keypress="{{messageInput_keydown}}" />
                </paper-input-decorator>
            </div>
        </div>
    </template>
    <script>
        (function() {
            Polymer('chat-page', {
                created: function() {
                    // Initialize and hint type to be array.
                    this.messages = [];
                    this.activeSpinner = true;
                    this.autoSpeak = false;
                },
                ready: function() {
                    var self = this;
                    var timeout;
                    var url = window.firebaseUrl + "chatRooms/public/.json";
                    $.get(url, function(data) {
                        if (self.activeSpinner) {
                            self.activeSpinner = false;
                        }
                        if (data) {
                        } else {
                            window.firebaseRef.child("chatRooms").child("public").set({});
                        }
                    });
                    window.firebaseRef.child('chatRooms').child('public').on('child_added', function(snapshot) {
                        if (self.activeSpinner) {
                            self.activeSpinner = false;
                        }
                        var message = snapshot.val();
                        self.messages.push(message);
                        self.scrollToBottom();
                        if (!timeout) {
                            timeout = setTimeout(function() {
                                self.autoSpeak = true;
                            }, 1000);
                        } else {
                            if (self.autoSpeak && self.user && self.user.name !== message.name) { // TODO: check user ID
                                speak(message.text);
                            }
                        }
                    });
                },
                goBack: function() {
                    this.fire('go-back');
                    this.autoSpeak = false;
                },
                messageInput_keydown: function(e) {
                    if (e.keyCode === 13) {
                        var text = e.target.value;
                        var time = new Date().getTime();
                        window.firebaseRef.child('chatRooms').child('public').push({name: this.user.name, text: text, time: time});
                        e.target.value = "";
                        speak(text);
                    }
                },
                turnOnSpeak: function() {
                    var self = this;
                    listen(function(text) {
                        var time = new Date().getTime();
                        window.firebaseRef.child('chatRooms').child('public').push({name: self.user.name, text: text, time: time});
                    });
                },
                transitionBegin: function() {
                },
                transitionEnd: function() {
                },
                userChanged: function(oldValue, newValue) {
                    this.user_ = newValue;
                },
                scrollToBottom: function() {
                    var $listChat = $(this.$.chatPage.scroller);
                    $listChat.stop().animate({
                        scrollTop: $listChat[0].scrollHeight
                    }, 500);
                }
            });
        })();
    </script>
</polymer-element>
