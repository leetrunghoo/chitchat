
<link rel="import" href="users-page.html">
<link rel="import" href="chat-page.html">
<link rel="import" href="login-page.html">

<polymer-element name="main-page">
    <template id="mainPage">
        <link rel="stylesheet" href="main-page.css">
        <!--<core-ajax id="ajax" url="data.json" response="{{users}}"></core-ajax>-->
        <core-drawer-panel id="drawerPanel" >

            <!-- Drawer -->
            <core-header-panel drawer>
                <core-image style="width:256px; height:100px; background-color: lightgray;"
                            sizing="cover" preload fade src="../images/cover.jpg">
                    <core-image style="width:70px; height:70px;"
                                sizing="cover" preload fade src="{{userLogin.avatar}}">
                    </core-image>
                </core-image>
                <core-menu selectedAttribute="">
                    <paper-item on-click="{{goUsersPage}}">
                        <core-icon icon="assignment"></core-icon>
                        <div>Users page</div>
                    </paper-item>
                    <paper-item on-click="{{goChat}}">
                        <core-icon icon="assignment"></core-icon>
                        <div>Chat page</div>
                    </paper-item>
                    <paper-item on-click="{{goLoginPage}}" hidden?="{{logined}}">
                                <core-icon icon="account-circle"></core-icon>
                        <div>Login</div>
                    </paper-item>
                    <paper-item on-click="{{logout}}" hidden?="{{!logined}}">
                                <core-icon icon="account-circle"></core-icon>
                        <div>Logout</div>
                    </paper-item>
                </core-menu>
            </core-header-panel>

            <!-- Main -->
            <div main layout vertical>
                <core-animated-pages id="pages" selected="{{selectedPage}}" fit
                                     transitions="hero-transition cross-fade slide-from-right">
                    <login-page id="page1" on-logined="{{goUsersPage}}"
                                center center-justified horizontal layout ></login-page>
                    <users-page id="page2" users="{{users}}" on-choose-user="{{goChatPage}}" on-toggle-drawer="{{openDrawer}}" 
                                center center-justified layout ></users-page>

                    <chat-page id="page3" user="{{user}}" on-go-back="{{goUsersPage}}"
                               center center-justified layout ></chat-page>

                </core-animated-pages>
            </div>
        </core-drawer-panel>
    </template>
    <script>
        (function() {
            var self;
            Polymer('main-page', {
                transitionBegin: function() {
                },
                transitionEnd: function() {
                },
                selectedPage: 1,
                login: false,
                userLogin: "",
                ready: function() {
                    self = this;
                    // Initialize and hint type to be array.
                    this.users = [
                        {id: 1, name: "Trung", status: "Nice to meet you"},
                        {id: 2, name: "Jerry", status: "Catch me if you can"},
                        {id: 3, name: "Tom", status: "You just wait!"},
                        {id: 4, name: "Terry", status: "Hello!"},
                        {id: 5, name: "Bob", status: "I'm sad"},
                        {id: 6, name: "Maria Ozawa", status: "My number: 090xxxxxx"},
                        {id: 7, name: "Suzuki", status: "yo!"}
                    ];
                    // Register the callback to be fired every time auth state changes
                    window.firebaseRef.onAuth(this.authDataCallback);
//                    this.authDataCallback(window.firebaseRef.getAuth());
                },
                authDataCallback: function(authData) {
                    if (authData) {
                        console.log("User is logged in with ", authData);
                        self.userLogin = getUserProfile(authData);
                        console.log("userLogin ", self.userLogin);
                        self.goUsersPage();
                        var url = window.firebaseUrl + "users/" + authData.uid + ".json";
                        $.get(url, function(user) {
                            if (user) {
                                showToast("Welcome back " + self.userLogin.name);
                            } else {
                                showToast("Hello " + self.userLogin.name);
                                window.firebaseRef.child("users").child(authData.uid).set(authData);
                            }
                        });
                        self.logined = true;
                    } else {
                        console.log("User is logged out");
                        self.logined = false;
                        self.selectedPage = 0;
                        self.userLogin = null;
                    }
                },
                closeDrawer: function() {
                    // Maybe this could wait till the next frame before animating
                    // out... right now it animates while the list is rebuilding
                    // and causes some jank
                    this.$.drawerPanel.closeDrawer();
                },
                openDrawer: function() {
                    this.$.drawerPanel.openDrawer();
                },
                goChatPage: function(e, detail, sender) {
                    var userData = detail;
                    if (userData) {
                        this.user = userData;
                        this.selectedPage = 2;
                        this.closeDrawer();
                        // TODO: pass roomId
                    }
                },
                goUsersPage: function(e, detail, sender) {
                    this.selectedPage = 1;
                    this.closeDrawer();
                },
                goLoginPage: function(e, detail, sender) {
                    this.selectedPage = 0;
                    this.closeDrawer();
                },
                logout: function(e, detail, sender) {
                    window.firebaseRef.unauth();
                    this.goLoginPage();
                    this.userLogin = null;
                }
            });
        })();
    </script>
</polymer-element>
